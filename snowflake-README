--connection to a snowflake account (using AWS)

snowsql  -a <> -u <>


-- Using a warehouse
USE WAREHOUSE <name>;

-- CREATING A DATABASE
CREATE OR REPLACE DATABASE <name>;

-- CREATING a schema
CREATE OR REPLACE SCHEMA <name>;

-- displaying all schemas under a WH@database
SHOW schemas;

Variant datatype: 
Used to store semi-structured data.

Example for loading an json file:

1. 
-- CREATING A Raw Source table:

CREATE OR REPLACE TABLE raw_src_tbl
( src VARIANT );

-- Creating an internal stage table

    -- Two options:

        -- 1. Using file_format TYPE paramteter:
        CREATE OR REPLACE STAGE raw_data_stg
        file_format = (type = 'JSON');

        --2. Using only the file_format parameter:

            --a. Create the file_format first

            CREATE OR REPLACE FILE FORMAT my_json_format
            TYPE = 'JSON'
            RECORD_DELIMITER='\\n'
            FIELD_DELIMITER=',';

            --b. Create the staging table with this file format.
            
            CREATE OR REPLACE STAGE raw_data_stg
            file_format = my_json_format;    


-- Loading the stage table with the raw data
PUT file:///home/prashant/snowflake/sales.json @raw_data_stg

-- Copying the data from stage to target

COPY INTO raw_src_tbl
from @raw_data_stg;


-- The entire json data will be stored in the VARIANT data type.
SELECT SUBSTR(src:location:state_city::string,1,2) AS state,
       SUBSTR(src:location:state_city::string,4) AS city, 
       src:location:zip::string as zip,
       src:price::number price,
       TO_TIMESTAMP_NTZ(src:sale_date::string) sale_date
FROM raw_src_tbl;

2.

-- Loading the stage table with the raw data
PUT file:///home/prashant/snowflake/contacts.json @raw_data_stg;

-- Copying the data from stage to target

COPY INTO raw_src_tbl
from @raw_data_stg;

-- The entire json data will be stored in the VARIANT data type.

SELECT * FROM
(
    SELECT src:id::number id, 
           src:name:first::string first_name, 
           c.value:type::string type,
           c.value:content::string content
    FROM raw_src_tbl s, 
         lateral flatten(input => src, path => 'contact') m,
         lateral flatten (input => m.value:business) c
)
PIVOT (max(content) for type IN ('phone','email')) as p(id,first_name, phone, email);


------
Shared Databases

SHARE -> object such as database, tables, views etc which can be imported by other databases / consumers.

Shares are named Snowflake objects that encapsulate all of the information required to share a database. Each share consists of:

    The privileges that grant access to the database(s) and the schema containing the objects to share.

    The privileges that grant access to the specific objects (tables, secure views, and secure UDFs).

    The consumer accounts with which the database and its objects are shared.

    New objects added to a share become immediately available to all consumers, providing real-time access to shared data.
    
    Access to a share (or any of the objects in a share) can be revoked at any time.
    
    
SNOWFLAKE database => provider of data which shares account usage and sample datasets for all accounts.
When an account is created, SNOWFLAKE database is automatically imported into each account from a Share named as ACCOUNT_USAGE.
Contains views similar to DBA* views in oracle.

Command -> show views;

------------------------------

-- creating a secure view ( can be used similar to a VPD in oracle) and are used specifically to enforce data privacy. These views do not enforce query optimization.
-- This is because the Snowflake query optimizer, when evaluating secure views, bypasses certain optimizations used for regular views. 
-- This may result in some impact on query performance for secure views.
CREATE OR REPLACE SECURE VIEW <name> AS <select>

-- Parameter for simuating a shared account

SIMULATED_DATA_SHARING_CONSUMER

--------------------------------------------------------

Process of creating a share

--PRODUCER ACCOUNT--


1. Create a share using ACCOUNT_ADMIN role.

use role accountadmin;

2. Create a share

CREATE OR REPLACE SHARE <name> COMMENT = '<comment>';

3. Grant the necessary privs to the share

3a. Grant USAGE on database
grant usage on database mydb to share mydb_shared;

3b. gramt USAGE on schema
grant usage on schema mydb.public to share mydb_shared;

3c. grant SELECT on objects
grant select on mydb.public.paid_sensitive_data to share mydb_shared;

4. Add accounts to the share

alter share mydb_shared set accounts = <consumer_account1, consumer_account2...>;

---------------------------------------------------------------------------

--CONSUMER consuming the SHARE--:

use role accountadmin;

show shares;

create database mydb_shared1 from share <provider_account>.mydb_shared;

/* Grant privileges on the database to other roles (e.g. SYSADMIN) in your account. */

grant imported privileges on database mydb_shared1 to sysadmin;

use role sysadmin;

show views;

create or replace WAREHOUSE reader_wh;

use warehouse <warehouse_name>;

select * from paid_sensitive_data;



----------------- READER ACCOUNT --------------------------------------
---------------------------------------------------------------------------

+-----------------------------------------------------------------------------------------+
| status                                                                                  |
|-----------------------------------------------------------------------------------------|
| {"accountName":"OW29219","loginUrl":"https://ow29219.us-east-1.snowflakecomputing.com"} |
+-----------------------------------------------------------------------------------------+
1 Row(s) produced. Time Elapsed: 1.543s


--------------------------------------------------------------------------------------------------------------------------------

Example for illustrating shares:

use role sysadmin;

create or replace table mydb.private.sensitive_data (
    name string,
    date date,
    time time(9),
    bid_price float,
    ask_price float,
    bid_size int,
    ask_size int,
    access_id string /* granularity for access */ )
    cluster by (date);

insert into mydb.private.sensitive_data
    values('AAPL',dateadd(day,  -1,current_date()), '10:00:00', 116.5, 116.6, 10, 10, 'STOCK_GROUP_1'),
          ('AAPL',dateadd(month,-2,current_date()), '10:00:00', 116.5, 116.6, 10, 10, 'STOCK_GROUP_1'),
          ('MSFT',dateadd(day,  -1,current_date()), '10:00:00',  58.0,  58.9, 20, 25, 'STOCK_GROUP_1'),
          ('MSFT',dateadd(month,-2,current_date()), '10:00:00',  58.0,  58.9, 20, 25, 'STOCK_GROUP_1'),
          ('IBM', dateadd(day,  -1,current_date()), '11:00:00', 175.2, 175.4, 30, 15, 'STOCK_GROUP_2'),
          ('IBM', dateadd(month,-2,current_date()), '11:00:00', 175.2, 175.4, 30, 15, 'STOCK_GROUP_2');

create or replace table mydb.private.sharing_access (
  access_id string,
  snowflake_account string
);


/* In the first insert, CURRENT_ACCOUNT() gives your account access to the AAPL and MSFT data.       */

insert into mydb.private.sharing_access values('STOCK_GROUP_1', CURRENT_ACCOUNT());


/* In the second insert, replace <consumer_account> with an account name; this account will have     */
/* access to IBM data only. Note that account names are case-sensitive and must be in uppercase      */
/* enclosed in single-quotes, e.g.                                                                   */
/*                                                                                                   */
/*      insert into into mydb.private.sharing_access values('STOCK_GROUP_2', 'ACCT1')                */
/*                                                                                                   */
/* To share the IBM data with multiple accounts, repeat the second insert for each account.          */

insert into mydb.private.sharing_access values('STOCK_GROUP_2', '<consumer_account>');
insert into mydb.private.SHARING_ACCESS values ('STOCK_GROUP_1','OW29219');



/* Create a secure view in the 'public' schema. This view filters the stock data from the first      */
/* table by account, using the mapping information in the second table.                              */

create or replace secure view mydb.public.paid_sensitive_data as
    select name, date, time, bid_price, ask_price, bid_size, ask_size
    from mydb.private.sensitive_data sd
    join mydb.private.sharing_access sa on sd.access_id = sa.access_id
    and sa.snowflake_account = current_account();

grant select on mydb.public.paid_sensitive_data to public;


/* Test the table and secure view by first querying the data as the provider account. */

select count(*) from mydb.private.sensitive_data;

select * from mydb.private.sensitive_data;

select count(*) from mydb.public.paid_sensitive_data;

select * from mydb.public.paid_sensitive_data;

-----Creating a Share:

use role ACCOUNTADMIN;

create managed account prax_reader_acct1 admin_name=<> admin_password='<>' type=reader;

show shares;

+-------------------------------+---------+-------------------------+-----------------------+----+-------+---------+
| created_on                    | kind    | name                    | database_name         | to | owner | comment |
|-------------------------------+---------+-------------------------+-----------------------+----+-------+---------|
| 2017-05-19 18:21:40.807 -0700 | INBOUND | SFC_SAMPLES.SAMPLE_DATA | SNOWFLAKE_SAMPLE_DATA |    |       |         |
| 2018-08-15 10:46:33.366 -0700 | INBOUND | SNOWFLAKE.ACCOUNT_USAGE | SNOWFLAKE             |    |       |         |
+-------------------------------+---------+-------------------------+-----------------------+----+-------+---------+

create or replace SHARE prax_share ;

grant usage on database MYDB to share prax_share;

grant usage on schema PUBLIC to share prax_share;

grant select on mydb.public.PAID_SENSITIVE_DATA to share prax_share;

SHOW GRANTS TO SHARE prax_share;

+-------------------------------+-----------+------------+---------------------------------+------------+--------------------+--------------+------------+
| created_on                    | privilege | granted_on | name                            | granted_to | grantee_name       | grant_option | granted_by |
|-------------------------------+-----------+------------+---------------------------------+------------+--------------------+--------------+------------|
| 2019-07-30 18:03:42.022 -0700 | USAGE     | DATABASE   | MYDB                            | SHARE      | GG42143.PRAX_SHARE | false        | SYSADMIN   |
| 2019-07-30 18:04:03.043 -0700 | USAGE     | SCHEMA     | MYDB.PUBLIC                     | SHARE      | GG42143.PRAX_SHARE | false        | SYSADMIN   |
| 2019-07-30 18:04:47.087 -0700 | SELECT    | VIEW       | MYDB.PUBLIC.PAID_SENSITIVE_DATA | SHARE      | GG42143.PRAX_SHARE | false        | SYSADMIN   |
+-------------------------------+-----------+------------+---------------------------------+------------+--------------------+--------------+------------+

alter share prax_share add accounts=OW29219;

------------------------------------------------
--Consumer:

--Login into the reader account:

use role accountadmin;

show shares;

+-------------------------------+---------+-------------------------+---------------+----+-------+---------+
| created_on                    | kind    | name                    | database_name | to | owner | comment |
|-------------------------------+---------+-------------------------+---------------+----+-------+---------|
| 2019-07-30 18:03:04.997 -0700 | INBOUND | GG42143.PRAX_SHARE      |               |    |       |         |
| 2018-08-15 10:46:33.366 -0700 | INBOUND | SNOWFLAKE.ACCOUNT_USAGE | SNOWFLAKE     |    |       |         |
+-------------------------------+---------+-------------------------+---------------+----+-------+---------+

create database prax_shared_db from share GG42143.PRAX_SHARE;

create or replace WAREHOUSE reader_wh;

use WAREHOUSE READER_WH;

use ROLE ACCOUNTADMIN;

grant imported privileges on database PRAX_SHARED_DB to sysadmin;

select * from PAID_SENSITIVE_DATA;











